!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery","./grid.base"],e):e(jQuery)}(function(f){"use strict";f.jgrid.extend({dbInit:function(e){return this.each(function(){"indexeddb"===e&&f(this).jqGrid("_initIndexedDB_")})},_initIndexedDB_:function(){this.each(function(){var l=this;indexedDB.databases().then(function(e){const r=indexedDB.open(l.p.dbconfig.dbname);r.onupgradeneeded=e=>{console.info("Database created: "+l.p.dbconfig.dbname)},r.onsuccess=function(e){const r=e.target.result;var o=parseInt(r.version),d=f.jgrid.getElemByAttrVal(l.p.colModel,"key",!0);async function t(c){var s,r=l.p.dbconfig;if("string"==typeof r.dataUrl){try{let e=await fetch(r.dataUrl,r.fetchOptions);s=await e.json(),null!==r.reader&&(s=f.jgrid.getAccessor(s,r.reader))}catch(e){return void console.log("Error:"+e)}f.jgrid.isFunction(r.beforeInsertData)&&(s=r.beforeInsertData.call(l,s))}else Array.isArray(r.dataUrl)&&(s=r.dataUrl);l.p.dbconfig.dbversion=o+1;r=indexedDB.open(r.dbname,o+1);r.onupgradeneeded=function(e){var r,o=e.target.result;if(!c){const i=o.createObjectStore(l.p.dbconfig.dbtable,{keyPath:d.name});for(let e=0;e<l.p.colModel.length;e++){var t=l.p.colModel[e];t.name===d.name?i.createIndex(t.name,t.name,{unique:!0}):i.createIndex(t.name,t.name,{unique:!1})}}const n=e.target.transaction,a=n.objectStore(l.p.dbconfig.dbtable);a.transaction.oncomplete=function(e){},a.transaction.onerror=function(e){f.jgrid.info_dialog("Error",e.target.error.name+" : "+e.target.error.message,"Close")};for(r of s)l.p.dbconfig.isKeyInData||(r[d.name]=Math.random().toString(16).slice(2)),a.put(r);l.p.dbconfig.ready_req=!0,l.grid.populate()},r.onerror=e=>{f.jgrid.info_dialog("Error",e.target.error.name+" : "+e.target.error.message,"Close")}}if(f.isEmptyObject(d))f.jgrid.info_dialog("Warning","Missed key: No uniquie key is set in colModel. Creating table fail","Close");else if(r.objectStoreNames.contains(l.p.dbconfig.dbtable))if(l.p.dbconfig.loadIfExists||l.p.dbconfig.deleteIfExists){const n=r.transaction(l.p.dbconfig.dbtable,"readwrite"),a=n.objectStore(l.p.dbconfig.dbtable),i=a.count();i.onsuccess=()=>{if(0<i.result)if(l.p.dbconfig.deleteIfExists){const e=a.clear();e.onsuccess=e=>{console.log("All records are cleared"),r.close(),t(!0)},e.onerror=e=>{f.jgrid.info_dialog("Error",e.target.error.name+" : "+e.target.error.message,"Close")}}else l.p.dbconfig.loadIfExists?(r.close(),t(!0)):(r.close(),l.p.dbconfig.ready_req=!0,l.grid.populate());else r.close(),t(!0)}}else r.close(),l.p.dbconfig.ready_req=!0,l.grid.populate();else r.close(),t(!1)},r.onerror=e=>{f.jgrid.info_dialog("Error",e.target.error.name+" : "+e.target.error.message,"Close")}})})},updateStorageRecord:async function(s,d){let l=this[0],g=l.p.dbconfig,e=l.p.datatype;return new Promise(function(o,i){if(Array.isArray(s)||(s=[s]),d=d||l.p.keyName,s=f.jgrid.normalizeDbData.call(l,s,l.p.colModel),"indexeddb"===e){const c=window.indexedDB.open(g.dbname);c.onsuccess=e=>{const r=c.result,t=r.transaction(g.dbtable,"readwrite"),n=(t.oncomplete=e=>{o(e),console.log("Transaction completed succefully")},t.onerror=r=>{i(r);try{f.jgrid.info_dialog.call("Error",r.target.error,"Close",{styleUI:l.p.styleUI})}catch(e){console.log(r.target.error)}},t.objectStore(g.dbtable));for(let o=0;o<s.length;o++){if(!s[o].hasOwnProperty(d)||""===s[o][d]){t.abort();break}const a=n.openCursor();a.onsuccess=e=>{const r=e.target.result;r&&((e=r.value)[d]===s[o][d]?(delete s[o].oper,e=Object.assign(e,s[o]),r.update(e)):r.continue())},a.onerror=e=>{console.log(e.target.error)}}}}})},addStorageRecord:async function(c,s){let d=this[0],l=d.p.dbconfig,e=d.p.datatype;return new Promise(function(n,a){if(Array.isArray(c)||(c=[c]),s=s||d.p.keyName,c=f.jgrid.normalizeDbData.call(d,c,d.p.colModel),"indexeddb"===e){const i=window.indexedDB.open(l.dbname);i.onsuccess=e=>{const r=i.result,o=r.transaction(l.dbtable,"readwrite"),t=(o.oncomplete=e=>{n(e),console.log("Transaction completed succefully")},o.onerror=r=>{a(r);try{f.jgrid.info_dialog.call("Error",r.target.error,"Close",{styleUI:d.p.styleUI})}catch(e){console.log(r.target.error)}},o.objectStore(l.dbtable));for(let e=0;e<c.length;e++)c[e].hasOwnProperty(s)&&""!==c[e][s]||(c[e][s]=Math.random().toString(16).slice(2)),t.add(c[e]).onsuccess=e=>{}}}})},deleteStorageRecord:async function(s,d){let l=this[0],g=l.p.dbconfig,e=l.p.datatype;return new Promise(function(n,a){if(Array.isArray(s)||(s=s.split(",")),d=d||l.p.keyName,"indexeddb"===e){var i=[],r={};for(let e=0;e<s.length;e++)r[d]=s[e],i.push(r);i=f.jgrid.normalizeDbData.call(l,i,l.p.colModel);const c=window.indexedDB.open(g.dbname);c.onsuccess=e=>{const r=c.result,o=r.transaction(g.dbtable,"readwrite"),t=(o.oncomplete=e=>{n(e),console.log("Transaction completed succefully")},o.onerror=r=>{a(r);try{f.jgrid.info_dialog.call("Error",r.target.error,"Close",{styleUI:l.p.styleUI})}catch(e){console.log(r.target.error)}},o.objectStore(g.dbtable));for(let r=0;r<s.length;r++)t.delete(i[r][d]).onsuccess=e=>{console.log("Deleted record: "+s[r])}}}})}})});